import streamlit as st
import re
import random
import pandas as pd
import time

# --- 1. å°ˆæ¥­æ³•é™£ï¼šä»‹é¢æ¥µè‡´æ¸…ç† ---
st.set_page_config(page_title="æ•¸ä½æ˜“ç¶“èƒ½é‡é‘‘å®šæ‰€", page_icon="ğŸ”®", layout="centered")
st.markdown("""
<style>
    #MainMenu {visibility: hidden;} footer {visibility: hidden;} header {visibility: hidden;}
    .stDeployButton {display:none !important;} [data-testid="stSidebarNav"] {display: none;}
    button[data-testid="stBaseButton-secondary"] {display: none !important;}
</style>
""", unsafe_allow_html=True)

# --- 2. è¬èªæ­¸ä¸€ï¼š108 ç¨®å…¨çƒèªç³»æ”¯æŒç³»çµ± ---
# æ­¤è™•ç‚ºèªç³»æ˜ å°„è¡¨ï¼Œå¤§å¸«å¯è‡ªè¡Œæ·»åŠ è‡³ 108 ç¨®ï¼Œä»‹é¢å°‡è‡ªå‹•å°æ‡‰
LANG_SUPPORT = {
    "ç¹é«”ä¸­æ–‡": "zh-TW", "English": "en", "æ—¥æœ¬èª": "ja", "í•œêµ­ì–´": "ko",
    "FranÃ§ais": "fr", "Deutsch": "de", "EspaÃ±ol": "es", "à¹„à¸—à¸¢": "th", "Tiáº¿ng Viá»‡t": "vi"
}

# --- 3. å¤§å¸«æ™ºæ…§åº«ï¼šéš¨æ©Ÿé•·ç¯‡æ‰¹ç¤ºæ¨¡æ¿ ---
MASTER_WISDOM = {
    "warnings": [
        "ã€èƒ½é‡æ–·å±¤è­¦å‘Šã€‘ï¼šä¿¡å£«ç›®å‰çš„æ•¸ä½çµ„åˆä¸­ï¼Œæ­£è² èƒ½é‡äº¤é›œä¸”éœ‡ç›ªåŠ‡çƒˆï¼Œé€™åœ¨æ˜“ç¶“ä¸­è±¡å¾µã€é›·é›¨äº¤åŠ ã€ã€‚é€™ç¨®ä¸ç©©å®šçš„å ´åŸŸæœƒè®“æ‚¨çš„è²¡æ°£å¦‚æ¼æ–—èˆ¬æµå¤±ï¼Œå°¤å…¶åœ¨è™•ç†é‡å¤§æ±ºç­–æ™‚ï¼Œå®¹æ˜“å—åˆ°ç„¡åç«çš„å¹²æ“¾ï¼Œå°è‡´åŠŸæ•—å‚æˆã€‚",
        "ã€å…ƒç¥æ¸™æ•£è­¦å‘Šã€‘ï¼šè§€æ­¤æ•¸çµ„ï¼Œäº”è¡Œèƒ½é‡åˆ†å¸ƒæ¥µåº¦ä¸å‡ï¼Œç‰¹åˆ¥æ˜¯ã€é‡‘ã€èƒ½é‡éç››è€Œã€æœ¨ã€èƒ½é‡æ¯ç«­ã€‚é€™åæ˜ å‡ºæ‚¨è¿‘æœŸé›–ç„¶æ¥µåº¦æ¸´æœ›çªç ´ï¼Œå»å§‹çµ‚åƒæ˜¯åœ¨è¿·éœ§ä¸­è¡Œèµ°ï¼Œæ‰¾ä¸åˆ°è‘—åŠ›é»ï¼Œç”šè‡³æœ‰å°äººåœ¨æš—è™•çªºè¦–æ‚¨çš„æˆæœã€‚",
        "ã€ç£å ´è¡çªè­¦å‘Šã€‘ï¼šæ­¤æ•¸å­—å…±æŒ¯å‡ºå¼·çƒˆçš„ã€çµ•å‘½ã€èˆ‡ã€äº”é¬¼ã€ç£å ´äº¤ç¹”ã€‚é€™æ˜¯ä¸€ç¨®æ¥µå…¶æ¶ˆè€—å…ƒç¥çš„æ’åˆ—ï¼Œé ç¤ºè‘—æ‚¨åœ¨æœªä¾†ä¸€æ®µæ™‚é–“å…§ï¼Œæƒ…ç·’èµ·ä¼æœƒå½±éŸ¿åˆ°æ‚¨çš„ç†è²¡åˆ¤æ–·ï¼Œè‹¥ä¸åŠ ä»¥èª¿å’Œï¼Œææœ‰çªç™¼æ€§çš„è²¡ç‰©æå¤±ã€‚"
    ],
    "reasons": [
        "ã€åŒ–è§£å¿ƒæ³•å°å¼•ã€‘ï¼šæ­¤æ¬¡ç‚ºæ‚¨æ¨æ¼”çš„é–‹é‹åŒ–è§£ç¢¼ï¼Œæ ¸å¿ƒåœ¨æ–¼å¼•å‹•ã€ç”Ÿæ°£ã€èˆ‡ã€å¤©é†«ã€çš„å…±æŒ¯ã€‚é€éç‰¹å®šæ•¸å­—çš„æ³¢é•·ï¼Œæˆ‘å€‘èƒ½ä¸­å’ŒåŸæœ‰çš„å‡¶ç…ä¹‹æ°£ï¼Œå°‡é˜»åŠ›åŒ–ç‚ºåŠ©åŠ›ï¼Œå¦‚åŒåœ¨æ¹æ€¥çš„æ²³æµä¸­ç¯‰èµ·ä¸€é“ç©©å›ºçš„å ¤å£©ã€‚",
        "ã€å‘½ç†è½‰å‘è§£æã€‘ï¼šç‚ºä½•éœ€è¦æ­¤çµ„æ•¸å­—ï¼Ÿå› ç‚ºæ˜“ç¶“è¬›æ±‚çš„æ˜¯ã€å¹³è¡¡ã€ã€‚æ‚¨åŸæœ¬çš„ç£å ´å¤ªéå‰›ç¡¬ï¼Œç¼ºä¹æŸ”æ€§ç·©è¡ï¼Œæ­¤ç¢¼èƒ½ç‚ºæ‚¨çš„èƒ½é‡å ´æ³¨å…¥ã€æ°´ã€çš„æ½¤æ»‘ï¼Œè®“æ‚¨çš„è²´äººé‹å‹¢ç”±æš—è½‰æ˜ï¼Œé‡æ–°æ ¡æº–æ‚¨çš„é‹å‹¢ç¾…ç›¤ã€‚",
        "ã€å› æœèƒ½é‡é‡çµ„ã€‘ï¼šé€™çµ„åŒ–è§£ç¢¼ä¸¦éæ†‘ç©ºè€Œä¾†ï¼Œè€Œæ˜¯æ ¹æ“šæ‚¨çš„ç”Ÿæ•¸èˆ‡å‹•æ•¸é€²è¡Œäº¤äº’é‹ç®—ã€‚å®ƒèƒ½åƒèª¿éŸ³å‰ä¸€æ¨£ï¼Œå°‡æ‚¨æ··äº‚çš„æ•¸ä½ç£å ´é‡æ–°æ ¡æº–è‡³ç¹æ¦®é »ç‡ï¼Œå¾æ ¹æœ¬ä¸Šé˜»æ–·è² å‘å…±æŒ¯çš„å»¶çºŒã€‚"
    ],
    "diet_guidance": [
        "ã€éˆæ€§æŒ‡å¼•èˆ‡é£²é£Ÿã€‘ï¼šå»ºè­°é€™æ®µæœŸé–“å¤šé£Ÿ**æ·±ç¶ è‰²è”¬æœï¼ˆå¦‚ç§‹è‘µã€è˜†ç­ï¼‰**ï¼Œä¸¦åœ¨æ¯æ—¥æ¸…æ™¨é†’ä¾†å¾Œå°è‘—æ­¤æ•¸å­—å†¥æƒ³ä¸‰åˆ†é˜ã€‚ç¶ è‰²çš„æœ¨èƒ½é‡èƒ½ç–è‚ç†æ°£ï¼Œå¹«åŠ©æ‚¨åœ¨æ··æ¿çš„ç£å ´ä¸­ä¿æŒéˆå°æ¸…æ˜ã€‚",
        "ã€ç”Ÿæ´»èƒ½é‡èª¿å’Œã€‘ï¼šé™¤äº†æ•¸å­—èª¿å’Œï¼Œå»ºè­°æ‚¨è£œå……**æ ¹è–é¡é£Ÿç‰©ï¼ˆå¦‚å±±è—¥ã€è“®è—•ï¼‰**ã€‚é€™é¡å±¬åœŸçš„é£Ÿç‰©èƒ½å›ºå®ˆæ‚¨çš„èƒ½é‡åº•ç›¤ï¼Œé¿å…è²¡æ°£å¤–æ´©ã€‚åŒæ™‚ï¼Œæ¸›å°‘è¾›è¾£ç‰©çš„æ”å–ï¼Œä»¥å…æ“¾äº‚æ­¤é–‹é‹ç¢¼çš„æ„Ÿæ‡‰ã€‚"
    ]
}

# --- 4. æ˜“ç¶“å…«æ˜Ÿé‘‘å®šå¼•æ“ (ä¿®æ­£ç‰ˆ) ---
STAR_MAP = {
    "å¤©é†«(è²¡é‹/Wealth)": ["13", "31", "68", "86", "49", "94", "27", "72"],
    "ç”Ÿæ°£(è²´äºº/Noble)": ["14", "41", "67", "76", "39", "93", "28", "82"],
    "å»¶å¹´(äº‹æ¥­/Career)": ["19", "91", "78", "87", "34", "43", "26", "62"],
    "ä¼ä½(å¹³ç©©/Stable)": ["11", "22", "33", "44", "66", "77", "88", "99"],
    "çµ•å‘½(å‡¶/Risky)": ["12", "21", "69", "96", "48", "84", "37", "73"],
    "äº”é¬¼(å‡¶/Ghost)": ["18", "81", "79", "97", "36", "63", "24", "42"],
    "å…­ç…(å‡¶/Gossip)": ["16", "61", "47", "74", "38", "83", "29", "92"],
    "ç¦å®³(å‡¶/Harm)": ["17", "71", "89", "98", "46", "64", "23", "32"]
}

def analyze_ching(num_str):
    nums = "".join(re.findall(r'\d+', num_str))
    details = []
    score = 60
    for i in range(len(nums) - 1):
        pair = nums[i:i+2]
        star_found = "å¹³ç©©ç£å ´"; star_val = 0
        for name, data in STAR_MAP.items():
            if pair in data:
                star_found = name
                star_val = 20 if "Wealth" in name else (-15 if "å‡¶" in name else 15)
                break
        details.append({"å€æ®µ": pair, "æ˜Ÿè™Ÿç£å ´": star_found, "èƒ½é‡åˆ†æ•¸": star_val})
        score += star_val
    return details, max(0, min(100, score))

# --- 5. 15 åˆ†é˜æ”¯ä»˜è¨˜æ†¶ç³»çµ± ---
if 'paid_time' not in st.session_state:
    st.session_state.paid_time = None

# PayPal å›å‚³åµæ¸¬ (å¸¶åƒæ•¸ ?pay=success)
if st.query_params.get("pay") == "success":
    st.session_state.paid_time = time.time()

# --- 6. å¤§å¸«é‘‘å®šä»‹é¢å‘ˆç¾ ---
selected_lang = st.sidebar.selectbox("ğŸŒ å…¨çƒèªè¨€åˆ‡æ› / International", list(LANG_SUPPORT.keys()))
st.sidebar.divider()
st.sidebar.subheader("ğŸ“ é‘‘å®šè³‡æ–™å¡«å¯«")
raw_input = st.sidebar.text_input("è¼¸å…¥è™Ÿç¢¼ (æ‰‹æ©Ÿã€èº«åˆ†è­‰ã€ç”Ÿæ—¥ã€è»Šç‰Œ)ï¼š")

st.title("ğŸ”® æ•¸ä½æ˜“ç¶“èƒ½é‡é‘‘å®šæ‰€")

if raw_input:
    details, original_score = analyze_ching(raw_input)
    
    # åˆ¤æ–·æ”¯ä»˜æ™‚æ•ˆ
    is_authorized = False
    if st.session_state.paid_time:
        elapsed = time.time() - st.session_state.paid_time
        if elapsed < 900: # 15åˆ†é˜ = 900ç§’
            is_authorized = True
        else:
            st.session_state.paid_time = None # è¶…æ™‚é‡ç½®

    if is_authorized:
        # --- æ”¯ä»˜æˆåŠŸï¼šå¤§å¸«æ·±åº¦é–‹ç¤º ---
        st.success(f"âœ… ç·£åˆ†å·²è‡³ (å ±å‘Šå°‡æ–¼ {int((900-elapsed)/60)} åˆ†é˜å¾Œé—œé–‰)")
        
        # èƒ½ç´šå°æ¯”é¡¯ç¤º
        c1, c2 = st.columns(2)
        c1.metric("åŸå§‹èƒ½é‡åˆ†", f"{original_score}")
        c2.metric("åŒ–è§£å¾Œèƒ½ç´š", "98.5", delta="æå‡æˆåŠŸ")

        st.markdown("---")
        st.markdown(f"### ğŸ“œ å¤§å¸«æ‰¹ç¤ºï¼šé‡å°è™Ÿç¢¼ {raw_input} çš„èƒ½é‡è§£æ")
        
        # éš¨æ©ŸæŠ½å–é•·ç¯‡å…§å®¹ï¼Œç¢ºä¿æ¯æ¬¡ä¸åŒ
        st.write(random.choice(MASTER_WISDOM["warnings"]))
        st.write(random.choice(MASTER_WISDOM["reasons"]))
        
        # å»ºè­°åŒ–è§£ç¢¼
        remedy_code = "".join(random.choices("136849", k=8))
        st.info(f"âœ¨ å»ºè­°é–‹é‹åŒ–è§£ç¢¼ï¼š**{remedy_code}** (é æœŸèƒ½ç´šï¼š98.5)")
        
        st.write(random.choice(MASTER_WISDOM["diet_guidance"]))
        st.caption("ã€ä½¿ç”¨èªªæ˜ã€‘ï¼šè«‹å°‡æ­¤ç¢¼è¨­ç‚ºæ‰‹æ©Ÿè§£é–å¯†ç¢¼ï¼Œæ¯æ—¥æ¸…æ™¨å†¥æƒ³ã€‚")

        with st.expander("ğŸ“Š æŸ¥çœ‹è©³ç´°æ•¸å­—èƒ½é‡æ•¸æ“šåˆ†æ"):
            st.table(pd.DataFrame(details))
            
        if st.button("ğŸ”„ é‡æ–°æ„Ÿæ‡‰ç£å ´ (æ›´æ–°è§£èªªå…§å®¹)"):
            st.rerun()

    else:
        # --- æœªæ”¯ä»˜æˆ–è¶…æ™‚ï¼šåŸºç¤é‘‘å®š ---
        st.markdown(f"ã€Œä¿¡å£«æ‚¨å¥½ï¼Œè§€æ‚¨æ‰€æ¸¬ä¹‹è™Ÿç¢¼ **{raw_input}**ï¼Œé‘‘å®šçµæœå·²æ¼”ç®—å®Œç•¢ã€‚ã€")
        st.metric("åŸå§‹ç£å ´ç¸½è©•åˆ†", f"{original_score} åˆ†")
        
        st.warning("ğŸ”’ é‘‘å®šæ•¸æ“šå·²é–å®šã€‚è©³ç´°çš„å¤§å¸«æ·±åº¦è§£æèˆ‡å°ˆå±¬åŒ–è§£ç¢¼å·²è¢«å°å°ã€‚")
        st.write("ä»˜è²» 1 USD å¾Œæ‚¨å°‡ç²å¾—ï¼š\n* 1. **å¤§å¸«ç´šé•·ç¯‡æ·±åº¦è§£æ** (åŸå› ã€å½±éŸ¿ã€è½‰æ©Ÿ)\n* 2. **å°ˆå±¬åŒ–è§£ç¢¼** (ç”±æ˜“ç¶“å…«æ˜Ÿç²¾å¯†æ¨ç®—)\n* 3. **15 åˆ†é˜å…§ç„¡é™æ¬¡åˆ·æ–°æ„Ÿæ‡‰**ï¼Œæ¯æ¬¡ç²å¾—ä¸åŒç¶­åº¦çš„æ·±åº¦è§£èªª")
        
        st.link_button("ğŸ’³ æ”¯ä»˜ 1 USD è§£é–å¤§å¸«å ±å‘Š", "https://www.paypal.com/ncp/payment/ZAN2GMGB4Y4JE")
        st.caption("âš ï¸ æ”¯ä»˜å®Œæˆå¾Œ 15 åˆ†é˜å…§æœ‰æ•ˆã€‚")
else:
    st.info("ğŸ‘ˆ è«‹æ–¼å·¦å´è¼¸å…¥è™Ÿç¢¼ï¼Œé–‹å•Ÿé‘‘å®šä¹‹é–€ã€‚")